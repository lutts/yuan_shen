import sys
import os
import random
from collections import namedtuple
from typing import NamedTuple

sys.path.append(os.path.abspath('../..'))

from analysis_utils.ys_timestamps import Ys_Timestamp, print_timestamps_summary, print_avg_min_max, null_timestamp

timestamp_dict = {
    "BHDS8270": ['00:00:03.667', "00:00:05.352", '00:00:00.000', '00:00:23.388', '00:00:23.322', '00:00:23.555'],
    "DTYP8972": ['00:00:02.750', "00:00:04.418", '00:00:21.155', '00:00:22.555', '00:00:22.655', '00:00:22.905'],
    "EEZM6926": ['00:00:02.150', "00:00:03.817", '00:00:20.688', '00:00:21.888', '00:00:21.972', '00:00:22.172'],
    "EVMZ0639": ['00:00:01.333', "00:00:03.033", '00:00:19.770', '00:00:21.055', '00:00:21.172', '00:00:21.422'],
    "FVCV7178": ['00:00:03.733', "00:00:05.385", '00:00:22.138', '00:00:23.438', '00:00:23.472', '00:00:23.705'],
    "GTEZ7481": ['00:00:03.067', "00:00:04.735", '00:00:21.455', '00:00:22.805', '00:00:22.855', '00:00:23.155'],
    "IELY5984": ['00:00:03.517', "00:00:05.202", '00:00:21.922', '00:00:23.322', '00:00:23.688', '00:00:23.988'],
    "IPPZ4195": ['00:00:02.767', "00:00:04.418", '00:00:21.172', '00:00:22.572', '00:00:22.638', '00:00:22.838'],
    "JFSR0678": ['00:00:06.927', "00:00:08.593", '00:00:25.313', '00:00:26.680', '00:00:26.947', '00:00:27.163'],
    "JGVE8401": ['00:00:04.018', "00:00:05.685", '00:00:22.605', '00:00:23.722', '00:00:24.055', '00:00:24.322'],
    "LBHS5383": ['00:00:02.583', "00:00:04.268", '00:00:21.038', '00:00:22.305', '00:00:22.205', '00:00:22.472'],
    "LIPF0502": ['00:00:02.667', "00:00:04.352", '00:00:21.072', '00:00:22.455', '00:00:22.638', '00:00:22.838'],
    "MGKI7539": ['00:00:01.517', "00:00:03.183", '00:00:19.903', '00:00:21.338', '00:00:21.555', '00:00:21.822'],
    "MQLA3567": ['00:00:03.350', "00:00:05.018", '00:00:21.738', '00:00:23.138', '00:00:23.055', '00:00:23.238'],
    "MQWJ1365": ['00:00:02.967', "00:00:04.635", '00:00:21.538', '00:00:22.688', '00:00:22.905', '00:00:23.172'],
    "MRKM1676": ['00:00:01.200', "00:00:02.883", '00:00:19.603', '00:00:20.955', '00:00:21.072', '00:00:21.338'],
    "NCQM5585": ['00:00:02.600', "00:00:04.268", '00:00:21.005', '00:00:22.405', '00:00:22.688', '00:00:22.972'],
    "PFRO8850": ['00:00:02.850', "00:00:04.502", '00:00:21.438', '00:00:22.622', '00:00:22.605', '00:00:22.905'],
    "QLJT5207": ['00:00:03.150', "00:00:04.818", '00:00:21.588', '00:00:22.888', '00:00:22.872', '00:00:23.122'],
    "RIBN0498": ['00:00:02.617', "00:00:04.268", '00:00:21.188', '00:00:22.305', '00:00:22.355', '00:00:22.588'],
    "SBQM7928": ['00:00:01.550', "00:00:03.217", '00:00:19.987', '00:00:21.272', '00:00:21.705', '00:00:22.005'],
    "SHZT0972": ['00:00:01.567', "00:00:03.233", '00:00:19.970', '00:00:21.338', '00:00:21.472', '00:00:21.772'],
    "SYXO7693": ['00:00:02.817', "00:00:04.502", '00:00:21.222', '00:00:22.588', '00:00:22.655', '00:00:22.922'],
    "TYML2640": ['00:00:03.033', "00:00:04.702", '00:00:21.438', '00:00:22.838', '00:00:22.955', '00:00:23.372'],
    "UABS3018": ['00:00:01.417', "00:00:03.092", '00:00:19.845', '00:00:21.247', '00:00:21.263', '00:00:21.513'],
    "UORH4038": ['00:00:02.383', "00:00:04.052", '00:00:20.788', '00:00:22.155', '00:00:22.205', '00:00:22.522'],
    "VHYK3226": ['00:00:01.650', "00:00:03.333", '00:00:20.055', '00:00:21.405', '00:00:21.372', '00:00:21.672'],
    "WASZ9691": ['00:00:02.583', "00:00:04.268", '00:00:20.988', '00:00:22.322', '00:00:22.472', '00:00:22.772'],
    "XMEE8128": ['00:00:02.333', "00:00:04.152", '00:00:20.905', '00:00:22.088', '00:00:22.005', '00:00:22.305'],
    "XQNA2177": ['00:00:02.733', "00:00:04.435", '00:00:21.338', '00:00:22.438', '00:00:22.488', '00:00:22.688'],
    "YHYA1341": ['00:00:02.567', "00:00:04.235", '00:00:20.972', '00:00:22.338', '00:00:22.638', '00:00:22.905'],
}

class Video_Timestamps(NamedTuple):
    q_anim_start: Ys_Timestamp
    q_damage: Ys_Timestamp
    bian_kuang_te_xian_dismiss: Ys_Timestamp
    pao_pao_disappear: Ys_Timestamp

    ling_hua_last_bonused:  Ys_Timestamp
    ling_hua_first_unbonused: Ys_Timestamp


def get_intervals(ys_timestamp_dict: dict[str, Video_Timestamps]):
    intervals_dict = {}
    for filename, t in ys_timestamp_dict.items():
        intervals_dict[filename] = {
            "Q动画开始 - Q出伤": t.q_damage - t.q_anim_start,
            "Q动画开始 - 边框特效消失": t.bian_kuang_te_xian_dismiss - t.q_anim_start,
            "边框特效消失 - 泡泡消失": t.pao_pao_disappear - t.bian_kuang_te_xian_dismiss,
            "Q动画开始 - 泡泡消失": t.pao_pao_disappear - t.q_anim_start,
            "Q出伤 - 泡泡消失 - 18": round(t.pao_pao_disappear - t.q_damage - 18, 3),
            "泡泡消失 - 最后一次增伤/最长可能增伤时间": (t.ling_hua_last_bonused - t.pao_pao_disappear,
                                       round(t.ling_hua_first_unbonused - t.pao_pao_disappear - 0.001 + 0.016, 3)),
            "Q动画开始 - 最后一次增伤/最长可能增伤时间": (t.ling_hua_last_bonused - t.q_anim_start, 
                               round(t.ling_hua_first_unbonused - t.q_anim_start - 0.001 + 0.016, 3)),
        }
    
    return intervals_dict


sorted_intervals = print_timestamps_summary(Video_Timestamps, timestamp_dict, get_intervals)

# 这里一些来源于其他视频的数据
q_anim_start_to_pao_pao_dismiss = [19.636, 19.655, 19.671, 19.672, 19.672, 19.672, 19.687, 19.687,
                                   19.687, 19.688, 19.688, 19.688, 19.689, 19.703, 19.703, 19.704,
                                   19.72, 19.737, 19.737, 19.738, 19.738, 19.739, 19.739, 19.739,
                                   19.739, 19.753, 19.754, 19.755, 19.755, 19.755, 19.771]
q_anim_start_to_pao_pao_dismiss.extend(sorted_intervals["Q动画开始 - 泡泡消失"])
print_avg_min_max([round(t - 18, 3) for t in q_anim_start_to_pao_pao_dismiss])

pp = [t[0] for t in sorted_intervals["泡泡消失 - 最后一次增伤/最长可能增伤时间"] if t[0] >= 0]
pp.extend([t[1] for t in sorted_intervals["泡泡消失 - 最后一次增伤/最长可能增伤时间"] if t[1] >= 0])
print_avg_min_max(pp)

t_lst = [Ys_Timestamp(t) for t in  [
"00:00:21.738", "00:00:22.038", "00:00:22.238", "00:00:22.538", "00:00:22.805", "00:00:23.022", "00:00:23.305", "00:00:23.505", "00:00:23.755", "00:00:24.055", "00:00:24.322", "00:00:24.522", "00:00:24.822", "00:00:25.322", "00:00:25.372", "00:00:25.622", "00:00:25.855", "00:00:26.038", "00:00:26.355", "00:00:26.538"

                                    ]]

print([t_lst[i] - t_lst[i-1] for i in range(1, len(t_lst))])
